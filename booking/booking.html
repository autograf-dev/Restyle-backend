<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<style>
  :root{
    --brand:#751a29;      /* primary */
    --brand-900:#852535;  /* hover */
    --dark:#000000;       /* cancel */
    --dark-900:#0a0a0a;   /* cancel hover */
    --muted:#6b7280;
    --border:#e5e7eb;
    --card:#ffffff;
    --bg:#ffffff;
    --text:#111827;
    --chip:#f3f4f6;
    --chip-text:#374151;

    --shadow: 0 1px 1px rgba(0,0,0,.04), 0 8px 24px rgba(0,0,0,.06);
    --shadow-hover: 0 2px 6px rgba(0,0,0,.06), 0 12px 36px rgba(0,0,0,.10);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Container: slightly narrower for that app-like feel */
  .container{
    max-width:860px;
    margin:0 auto;
    padding:clamp(12px,4.5vw,28px);
    padding-left:max(12px, env(safe-area-inset-left));
    padding-right:max(12px, env(safe-area-inset-right));
  }

  /* —— Brand / Hero —— */
  header.brand{
    position:relative;
    border-radius:22px;
    padding-block:clamp(18px,5vw,38px);
    margin-top:10px;
    background:
      radial-gradient(900px 180px at 50% -80px, rgba(117,26,41,.08), transparent 55%),
      radial-gradient(700px 150px at 0% -40px, rgba(117,26,41,.06), transparent 60%),
      var(--card);
    box-shadow:var(--shadow);
    border:1px solid var(--border);
    text-align:center;
  }
  .page-title{
    margin:0;
    font-size:clamp(20px,5.2vw,28px);
    line-height:1.15; font-weight:800; letter-spacing:-.01em;
  }

  /* Greeting */
  .greet{ display:grid; gap:8px; justify-items:center; margin-top:6px }
  .greet-name{ font-size:clamp(22px,4.4vw,30px); font-weight:800; letter-spacing:-.01em; line-height:1.12 }
  .greet-contact{ font-size:13px; color:var(--muted) }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    background:var(--chip); color:var(--chip-text);
    padding:6px 12px; border-radius:999px; font-weight:600; text-decoration:none;
    border:1px solid var(--border);
    box-shadow: inset 0 -1px 0 #11182714;
  }
  .greet-help{ margin:0; color:var(--muted); font-size:clamp(13px,3.6vw,14px) }

  /* Section header like UNDERSTATEMNT */
  .list-header{ margin:18px 0 8px }
  .section-title{
    display:flex; align-items:center; gap:12px;
    font-weight:800; letter-spacing:-.01em;
    font-size:clamp(18px,4vw,22px);
    margin:0;
  }
  .section-title .rule{ height:1px; background:var(--border); flex:1; border-radius:1px }

  /* Buttons */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 14px; border-radius:12px; border:1px solid transparent;
    cursor:pointer; font-weight:700; font-size:clamp(.95rem,3.9vw,1rem);
    transition:.18s ease; text-decoration:none; user-select:none;
    min-height:44px;
  }
  .btn svg{ flex:0 0 auto }
  .btn-primary{ background:var(--brand); color:#fff; box-shadow:0 1px 0 #00000018, 0 4px 14px rgba(117,26,41,.25) }
  .btn-primary:hover{ background:var(--brand-900); transform:translateY(-1px) }
  .btn-primary:disabled{ background:#9ca3af; cursor:not-allowed; transform:none }
  .btn-dark{ background:var(--dark); color:#fff; box-shadow:0 1px 0 #00000018, 0 6px 18px rgba(0,0,0,.25) }
  .btn-dark:hover{ background:var(--dark-900); transform:translateY(-1px) }
  .btn-dark:disabled{ background:#9ca3af; cursor:not-allowed; transform:none }

  /* List grid */
  .bookings-grid{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px }

  /* Cards */
  .booking-card{
    background:var(--card); border:1px solid var(--border); border-radius:18px;
    padding:16px 16px 12px; box-shadow:var(--shadow);
    transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease;
    animation:fadeIn .22s ease both;
  }
  .booking-card:hover{ box-shadow:var(--shadow-hover); transform:translateY(-1px); border-color:color-mix(in oklab, var(--border) 70%, var(--brand) 30%) }

  .booking-header{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    padding-bottom:10px; border-bottom:1px dashed var(--border); margin-bottom:10px; flex-wrap:wrap
  }
  .booking-title{ font-size:clamp(1rem,4.6vw,1.15rem); font-weight:800; margin:0; letter-spacing:.1px; line-height:1.25 }
  .booking-pill{
    display:inline-flex; align-items:center; padding:5px 12px; border-radius:999px;
    font-size:.82rem; font-weight:700; background:#eef2f7; color:#0f172a; border:1px solid var(--border)
  }
  .pill-cancelled{ background:#f3f4f6; color:#6b7280 }

  .booking-details{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px }
  @media (max-width:720px){ .booking-details{ grid-template-columns:1fr } }
  .detail-item{ display:flex; flex-direction:column; gap:4px }
  .detail-label{ font-size:.78rem; color:var(--muted); font-weight:700; letter-spacing:.04em; text-transform:uppercase }
  .detail-value{ font-size:1rem; font-weight:600 }

  .booking-actions{ display:flex; gap:10px; justify-content:stretch; padding-top:10px; border-top:1px dashed var(--border); flex-wrap:wrap }
  @media (max-width:600px){ .booking-actions .btn{ width:100% } }

  .muted{ color:var(--muted); text-align:center; margin-top:10px; font-size:1rem }

  /* Time chip */
  .time-notification{
    display:inline-flex; align-items:center; gap:6px; padding:4px 9px; border-radius:999px;
    font-size:.74rem; font-weight:800; margin-left:8px; border:1px solid var(--border)
  }
  .time-notification.urgent{ background:#fef2f2; color:#b91c1c; }
  .time-notification.warning{ background:#fffbeb; color:#b45309; }
  .time-notification.normal{ background:#f0fdf4; color:#15803d; }
  .time-notification.closed{ background:#f3f4f6; color:#374151; }

  /* Skeletons */
  .skeleton{
    background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 50%,#f3f4f6 75%);
    background-size:200% 100%; animation:loading 1.4s infinite; border-radius:8px
  }
  @keyframes loading{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .skeleton-card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:12px; box-shadow:var(--shadow) }
  .skeleton-title{ height:20px; width:60%; margin-bottom:12px }
  .skeleton-detail{ height:12px; margin-bottom:8px }
  .skeleton-detail.short{ width:40% } .skeleton-detail.medium{ width:60% } .skeleton-detail.long{ width:80% }

  /* Toasts */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
  }
  .toast {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  .toast.show { transform: translateX(0); opacity: 1; }
  .toast.success { border-left: 4px solid #10b981; }
  .toast.error { border-left: 4px solid #ef4444; }
  .toast.warning { border-left: 4px solid #f59e0b; }
  .toast.info { border-left: 4px solid #3b82f6; }
  .toast-icon { flex-shrink: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
  .toast-content { flex: 1; min-width: 0; }
  .toast-title { font-weight: 600; font-size: 14px; margin: 0 0 2px 0; color: var(--text); }
  .toast-message { font-size: 13px; color: var(--muted); margin: 0; line-height: 1.3; }
  .toast-close { background: none; border: none; color: var(--muted); cursor: pointer; padding: 4px; border-radius: 6px; transition: background-color 0.2s; flex-shrink: 0; }
  .toast-close:hover { background: var(--chip); }
  .toast-progress { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--brand); border-radius: 0 0 12px 12px; animation: toastProgress 5s linear forwards; }
  @keyframes toastProgress { from { width: 100%; } to { width: 0%; } }

  /* Subtle mount anim */
  @keyframes fadeIn{ from{ opacity:0; transform:translateY(2px) } to{ opacity:1; transform:none } }

  /* Larger screens: keep it comfy, not too wide */
  @media (min-width: 1024px){
    .container{ max-width:760px; }
  }
</style>
</head>

<body>
<header class="container brand">
  <img src="/logos/logo.png" alt="Restyle Salon" class="brand-logo" />
  <div id="greeting" class="greet">
    <div class="greet-name">Loading…</div>
    <div class="greet-contact"></div>
    <p class="greet-help">Please wait while we fetch your appointments.</p>
  </div>
</header>

<main class="container">
  <!-- UNDERSTATEMNT-style section header just above the list -->
  <div class="list-header">
    <h2 class="section-title">
      <span>Your bookings</span>
      <span class="rule"></span>
    </h2>
  </div>

  <div id="status" class="muted">Loading...</div>
  <div id="bookings-container"></div>
</main>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
  const contactId = new URLSearchParams(location.search).get("id");
  const statusEl = document.getElementById("status");
  const bookingsContainer = document.getElementById("bookings-container");
  const greetingEl = document.getElementById("greeting");
  const toastContainer = document.getElementById("toast-container");

  // Toast notification system
  function showToast(type, title, message, duration = 5000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icon = getToastIcon(type);
    toast.innerHTML = `
      <div class="toast-icon">${icon}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="removeToast(this.parentElement)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      <div class="toast-progress"></div>
    `;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => removeToast(toast), duration);
  }
  function getToastIcon(type) {
    const icons = {
      success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>',
      error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
      warning: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>'
    };
    return icons[type] || icons.info;
  }
  function removeToast(toast) {
    toast.classList.remove('show');
    setTimeout(() => { if (toast.parentElement) toast.parentElement.removeChild(toast); }, 300);
  }

  if (!contactId) {
    greetingEl.innerHTML = `
      <div class="greet-name">We couldn’t find your link</div>
      <div class="greet-contact"></div>
      <p class="greet-help">This URL is not valid. Please use your personal link from Restyle.</p>
    `;
  } else {
    Promise.all([fetchContact(), loadBookings()]);
  }

  async function fetchContact(){
    try{
      // fetch and display FIRST NAME only
      const res = await fetch(`https://restyle-backend.netlify.app/.netlify/functions/getContact?id=${contactId}`);
      const data = await res.json();
      const firstOnly = (res.ok && data.contact)
        ? (data.contact.firstName || 'there')
        : 'there';

      const phone = (res.ok && data.contact && data.contact.phone) ? String(data.contact.phone) : '';
      const tel = phone.replace(/\D/g,''); // dialable

      greetingEl.innerHTML = `
        <div class="greet-name">Welcome ${escapeHtml(firstOnly)}</div>
        <div class="greet-contact">
          ${phone ? `<a class="chip" href="tel:${tel}">${escapeHtml(phone)}</a>` : ``}
        </div>
        <p class="greet-help"> Here's what's coming up with RESTYLE SALON. Need to make changes? Just reschedule or cancel below.</p>
      `;
    }catch(e){
      greetingEl.innerHTML = `
        <div class="greet-name">Welcome</div>
        <div class="greet-contact"></div>
        <p class="greet-help">Below are your appointments.</p>
      `;
    }
  }

  /* -------- time helpers (unchanged logic) -------- */
  function parseAsEdmonton(isoLike) {
    if (!isoLike) return null;
    const str = String(isoLike).trim();
    if (/[zZ]|[+-]\d{2}:?\d{2}$/.test(str)) return new Date(str);
    const m = str.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})(?::(\d{2}))?/);
    if (!m) return new Date(str);
    const [ , Y, M, D, h, m2, s ] = m.map(x => (x === undefined ? x : Number(x)));
    const edmonton = new Date(Date.UTC(Y, M - 1, D, h, m2, s || 0));
    const tz = 'America/Edmonton';
    const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, hour12: false,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
    const parts = fmt.formatToParts(edmonton).reduce((acc,p)=>{acc[p.type]=p.value;return acc;},{});
    const reconstructed = Date.UTC(
      Number(parts.year), Number(parts.month) - 1, Number(parts.day),
      Number(parts.hour), Number(parts.minute), Number(parts.second)
    );
    const offsetMs = reconstructed - edmonton.getTime();
    return new Date(edmonton.getTime() - offsetMs);
  }
  function getTimeUntilStart(startTime) {
    if (!startTime) return null;
    const start = parseAsEdmonton(startTime);
    if (!start) return null;
    const now = new Date();
    return start.getTime() - now.getTime();
  }
  function getPriorityLevel(startTime) {
    const ms = getTimeUntilStart(startTime);
    if (ms === null) return 'normal';
    const hrs = ms / 36e5;
    if (hrs < 0) return 'closed';
    if (hrs < 2) return 'urgent';
    if (hrs < 24) return 'warning';
    return 'normal';
  }
  function formatTimeRemaining(startTime) {
    const ms = getTimeUntilStart(startTime);
    if (ms === null) return 'Unknown';
    if (ms < 0) return 'Event closed';
    const hours = Math.floor(ms / 36e5);
    const minutes = Math.floor((ms % 36e5) / 6e4);
    if (hours > 24) {
      const days = Math.floor(hours / 24);
      return `In ${days}d ${hours % 24}h`;
    } else if (hours > 0) {
      return `In ${hours}h ${minutes}m`;
    } else {
      return `In ${minutes}m`;
    }
  }
  function formatToEdmonton(isoString) {
    if (!isoString) return 'N/A';
    try{
      const date = parseAsEdmonton(isoString);
      return date.toLocaleString('en-US', {
        timeZone: 'America/Edmonton',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZoneName: 'short'
      });
    }catch(e){ return isoString }
  }
  function formatDuration(startIso, endIso){
    if(!startIso || !endIso) return '—';
    const mins = Math.max(0, Math.round((parseAsEdmonton(endIso) - parseAsEdmonton(startIso)) / 60000));
    const h = Math.floor(mins/60), m = mins%60;
    if(h && m) return `${h}h ${m}m`;
    if(h) return `${h}h`;
    return `${m} mins`;
  }

  function showSkeletons() {
    bookingsContainer.innerHTML = `
      <div class="skeleton-card">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-detail medium"></div>
        <div class="skeleton skeleton-detail short"></div>
        <div class="skeleton skeleton-detail long"></div>
        <div class="skeleton skeleton-detail medium"></div>
      </div>
      <div class="skeleton-card">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-detail short"></div>
        <div class="skeleton skeleton-detail long"></div>
        <div class="skeleton skeleton-detail medium"></div>
        <div class="skeleton skeleton-detail short"></div>
      </div>
    `;
  }

  async function loadBookings() {
    statusEl.textContent = "";
    showSkeletons();

    try {
      const res = await fetch(`https://restyle-backend.netlify.app/.netlify/functions/bookings?contactId=${encodeURIComponent(contactId)}`, {
        headers: { "Accept": "application/json" },
        cache: "no-store",
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to load bookings");

      const list = data.bookings || [];
      if (list.length === 0) {
        bookingsContainer.innerHTML = "";
        statusEl.textContent = "No bookings found.";
        return;
      }

      const enriched = await Promise.all(
        list.map(async (booking) => {
          const details = { ...booking };

          // calendar -> service name
          if (booking.calendar_id) {
            try {
              const calRes = await fetch(`https://restyle-backend.netlify.app/.netlify/functions/Calendarget?id=${booking.calendar_id}`);
              const cal = await calRes.json();
              if (calRes.ok && cal.calendar) {
                details.serviceName = cal.calendar.name || 'Untitled Booking';
              }
            } catch {}

          }

          // appointment details
          try {
            const bRes = await fetch(`https://restyle-backend.netlify.app/.netlify/functions/getBooking?id=${booking.id}`);
            const bData = await bRes.json();
            if (bRes.ok && bData.appointment) {
              details.startTime = bData.appointment.startTime;
              details.endTime = bData.appointment.endTime;
              details.appointmentStatus = bData.appointment.appointmentStatus;
              details.assignedUserId = bData.appointment.assignedUserId;
            }
          } catch {}

          // staff details (more robust — fills first+last from 'name' when needed)
          if (details.assignedUserId) {
            try {
              const sRes = await fetch(`https://restyle-backend.netlify.app/.netlify/functions/Staff?id=${details.assignedUserId}`);
              const sData = await sRes.json();
              
              console.log('Staff API response for userId:', details.assignedUserId, sData);

              const first =
                sData?.data?.firstName ||
                sData?.staff?.firstName ||
                sData?.users?.firstName ||
                sData?.firstName || '';

              const last =
                sData?.data?.lastName ||
                sData?.staff?.lastName ||
                sData?.users?.lastName ||
                sData?.lastName || '';

              const fullRaw =
                sData?.data?.name ||
                sData?.name ||
                sData?.displayName || '';

              console.log('Extracted staff data - first:', first, 'last:', last, 'fullRaw:', fullRaw);

              let f = (first || '').trim();
              let l = (last || '').trim();

              // If API only gives a single "name", split it smartly
              if (!f && !l && fullRaw) {
                const full = String(fullRaw).trim().replace(/\s+/g,' ');
                const parts = full.split(' ');
                if (parts.length === 1) {
                  f = parts[0]; l = '';
                } else {
                  // put everything except last into first, last token as last name
                  l = parts.pop();
                  f = parts.join(' ');
                }
              }

              // As a final fallback, if still empty but we had fullRaw, show that as first name
              if (!f && fullRaw) {
                f = String(fullRaw).trim();
              }

              details.assignedStaffFirstName = f || '';
              details.assignedStaffLastName  = l || '';
              details.assignedStaffDisplay   = [f, l].filter(Boolean).join(' ') || 'Staff';
              
              console.log('Final staff details - firstName:', details.assignedStaffFirstName, 'lastName:', details.assignedStaffLastName, 'display:', details.assignedStaffDisplay);

            } catch (e) {
              console.error('Staff fetch failed for userId:', details.assignedUserId, e);
              // If staff endpoint fails, keep fields undefined; renderer will handle gracefully
            }
          }

          return details;
        })
      );

      /* ONLY upcoming (future) bookings, incl. later today — unchanged behavior */
      const nowMs = Date.now();
      const upcomingOnly = enriched.filter(b => {
        if (!b.startTime) return false;
        const t = parseAsEdmonton(b.startTime).getTime();
        return Number.isFinite(t) && t >= nowMs;
      });

      // Partition AFTER filtering (unchanged logic)
      const sortByStart = (a,b) => parseAsEdmonton(a.startTime) - parseAsEdmonton(b.startTime);
      const confirmed = [];
      const cancelled = [];
      for (const b of upcomingOnly) {
        const s = (b.appointmentStatus || '').toLowerCase();
        if (s === 'confirmed') confirmed.push(b);
        else if (s === 'cancelled') cancelled.push(b);
      }
      confirmed.sort(sortByStart);
      cancelled.sort(sortByStart);

      const ordered = [...confirmed, ...cancelled];

      if (ordered.length === 0) {
        bookingsContainer.innerHTML = "";
        statusEl.textContent = "No upcoming bookings.";
        return;
      }

      bookingsContainer.innerHTML = `<div class="bookings-grid">${ordered.map(renderBookingCard).join('')}</div>`;
      statusEl.style.display = "none";
    } catch (err) {
      console.error(err);
      bookingsContainer.innerHTML = "";
      statusEl.textContent = "❌ Failed to load bookings.";
    }
  }

  function renderBookingCard(booking) {
    const withinTwoHours = (() => {
      if (!booking.startTime) return false;
      const start = parseAsEdmonton(booking.startTime);
      const now = new Date();
      return start.getTime() <= now.getTime() + 2 * 60 * 60 * 1000;
    })();

    const isCancelled = (booking.appointmentStatus || '').toLowerCase() === 'cancelled';

    // Prefer derived display if present; otherwise build from first/last
    const displayStaff = booking.assignedStaffDisplay ||
      `${booking.assignedStaffFirstName || ''} ${booking.assignedStaffLastName || ''}`.trim();

    const staffName = displayStaff || 'Unassigned';

    const pill = isCancelled
      ? `<span class="booking-pill pill-cancelled">Cancelled</span>`
      : `<span class="booking-pill">with ${escapeHtml(staffName)}</span>`;

    const timeChip = isCancelled ? '' :
      `<span class="time-notification ${getPriorityLevel(booking.startTime)}">${formatTimeRemaining(booking.startTime)}</span>`;

    return `
      <div class="booking-card">
        <div class="booking-header">
          <h3 class="booking-title">${escapeHtml(booking.serviceName || 'Untitled Booking')} ${timeChip}</h3>
          ${pill}
        </div>

        <div class="booking-details">
          <div class="detail-item">
            <span class="detail-label">Start Time</span>
            <span class="detail-value">${formatToEdmonton(booking.startTime)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Duration</span>
            <span class="detail-value">${formatDuration(booking.startTime, booking.endTime)}</span>
          </div>
        </div>

        ${isCancelled ? '' : `
          <div class="booking-actions">
            <a href="/update-booking?id=${booking.id}"
               class="btn btn-primary ${withinTwoHours ? 'disabled' : ''}"
               ${withinTwoHours ? 'onclick="return false;" title="Cannot reschedule - booking starts within 2 hours"' : ''}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
              </svg>
              Reschedule
            </a>

            <button class="btn btn-dark" ${withinTwoHours ? 'disabled title="Cannot cancel - booking starts within 2 hours"' : ''} onclick="cancelBooking('${booking.id}')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
              Cancel
            </button>
          </div>
        `}
      </div>
    `;
  }

  async function cancelBooking(id) {
    if (!confirm("Are you sure you want to cancel this booking?")) return;
    showToast('info', 'Cancelling...', 'Please wait while we cancel your appointment.', 3000);
    try {
      const res = await fetch(
        "https://restyle-backend.netlify.app/.netlify/functions/cancelbooking",
        {
          method: "POST",
          headers: { "Accept": "application/json", "Content-Type": "application/json" },
          body: JSON.stringify({ bookingId: id }),
        }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || "Cancel failed");
      await loadBookings();
      showToast('success', 'Appointment Cancelled', 'Your appointment has been successfully cancelled.');
    } catch (err) {
      console.error(err);
      showToast('error', 'Cancellation Failed', 'Failed to cancel appointment: ' + err.message);
    }
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"'`=\/]/g, s => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;",
      "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
    }[s]));
  }
</script>